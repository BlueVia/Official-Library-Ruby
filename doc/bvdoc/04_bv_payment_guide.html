<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>File: 04_bv_payment_guide [RDoc Documentation]</title>

  <link type="text/css" media="screen" href="../rdoc.css" rel="stylesheet" />

  <script src="../js/jquery.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../js/thickbox-compressed.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../js/quicksearch.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../js/darkfish.js" type="text/javascript"
    charset="utf-8"></script>
</head>

<body class="file">
  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../index.html">Home</a>
          <a href="../index.html#classes">Classes</a>
          <a href="../index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="project-metadata">
      
      
      <div id="fileindex-section" class="section project-section">
        <h3 class="section-header">Files</h3>
        <ul>
        
          <li class="file"><a href="../Gemfile.html">Gemfile</a></li>
        
          <li class="file"><a href="../Rakefile.html">Rakefile</a></li>
        
          <li class="file"><a href="../UserGuide.html">UserGuide</a></li>
        
          <li class="file"><a href="../bvdoc/00_bv_oauth_guide.html">00_bv_oauth_guide</a></li>
        
          <li class="file"><a href="../bvdoc/01_bv_advertising_guide.html">01_bv_advertising_guide</a></li>
        
          <li class="file"><a href="../bvdoc/02_bv_location_guide.html">02_bv_location_guide</a></li>
        
          <li class="file"><a href="../bvdoc/03_bv_directory_guide.html">03_bv_directory_guide</a></li>
        
          <li class="file"><a href="../bvdoc/04_bv_payment_guide.html">04_bv_payment_guide</a></li>
        
          <li class="file"><a href="../bvdoc/05_bv_sms_mt_guide.html">05_bv_sms_mt_guide</a></li>
        
          <li class="file"><a href="../bvdoc/06_bv_mms_mt_guide.html">06_bv_mms_mt_guide</a></li>
        
          <li class="file"><a href="../bvdoc/07_bv_sms_mo_guide.html">07_bv_sms_mo_guide</a></li>
        
          <li class="file"><a href="../bvdoc/08_bv_mms_mo_guide.html">08_bv_mms_mo_guide</a></li>
        
        </ul>
      </div>
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class Index
          <span class="search-toggle"><img src="../images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="../Bluevia.html">Bluevia</a></li>
        
          <li><a href="../Bluevia/BVAdvertising.html">Bluevia::BVAdvertising</a></li>
        
          <li><a href="../Bluevia/BVAdvertisingClient.html">Bluevia::BVAdvertisingClient</a></li>
        
          <li><a href="../Bluevia/BVBaseClient.html">Bluevia::BVBaseClient</a></li>
        
          <li><a href="../Bluevia/BVDirectory.html">Bluevia::BVDirectory</a></li>
        
          <li><a href="../Bluevia/BVDirectoryClient.html">Bluevia::BVDirectoryClient</a></li>
        
          <li><a href="../Bluevia/BVLocation.html">Bluevia::BVLocation</a></li>
        
          <li><a href="../Bluevia/BVLocationClient.html">Bluevia::BVLocationClient</a></li>
        
          <li><a href="../Bluevia/BVMoClient.html">Bluevia::BVMoClient</a></li>
        
          <li><a href="../Bluevia/BVMoMms.html">Bluevia::BVMoMms</a></li>
        
          <li><a href="../Bluevia/BVMoMmsClient.html">Bluevia::BVMoMmsClient</a></li>
        
          <li><a href="../Bluevia/BVMoSms.html">Bluevia::BVMoSms</a></li>
        
          <li><a href="../Bluevia/BVMoSmsClient.html">Bluevia::BVMoSmsClient</a></li>
        
          <li><a href="../Bluevia/BVMode.html">Bluevia::BVMode</a></li>
        
          <li><a href="../Bluevia/BVMtClient.html">Bluevia::BVMtClient</a></li>
        
          <li><a href="../Bluevia/BVMtMms.html">Bluevia::BVMtMms</a></li>
        
          <li><a href="../Bluevia/BVMtMmsClient.html">Bluevia::BVMtMmsClient</a></li>
        
          <li><a href="../Bluevia/BVMtSms.html">Bluevia::BVMtSms</a></li>
        
          <li><a href="../Bluevia/BVMtSmsClient.html">Bluevia::BVMtSmsClient</a></li>
        
          <li><a href="../Bluevia/BVOauth.html">Bluevia::BVOauth</a></li>
        
          <li><a href="../Bluevia/BVOauthClient.html">Bluevia::BVOauthClient</a></li>
        
          <li><a href="../Bluevia/BVPayment.html">Bluevia::BVPayment</a></li>
        
          <li><a href="../Bluevia/BlueviaError.html">Bluevia::BlueviaError</a></li>
        
          <li><a href="../Bluevia/ConnectionError.html">Bluevia::ConnectionError</a></li>
        
          <li><a href="../Bluevia/Errors.html">Bluevia::Errors</a></li>
        
          <li><a href="../Bluevia/IConnector.html">Bluevia::IConnector</a></li>
        
          <li><a href="../Bluevia/IConnector/BVHttpOAuthConnector.html">Bluevia::IConnector::BVHttpOAuthConnector</a></li>
        
          <li><a href="../Bluevia/IParser.html">Bluevia::IParser</a></li>
        
          <li><a href="../Bluevia/IParser/JsonParser.html">Bluevia::IParser::JsonParser</a></li>
        
          <li><a href="../Bluevia/IParser/JsonRpcParser.html">Bluevia::IParser::JsonRpcParser</a></li>
        
          <li><a href="../Bluevia/IParser/MultipartParser.html">Bluevia::IParser::MultipartParser</a></li>
        
          <li><a href="../Bluevia/IParser/XmlParser.html">Bluevia::IParser::XmlParser</a></li>
        
          <li><a href="../Bluevia/ISerializer.html">Bluevia::ISerializer</a></li>
        
          <li><a href="../Bluevia/ISerializer/JsonRpcSerializer.html">Bluevia::ISerializer::JsonRpcSerializer</a></li>
        
          <li><a href="../Bluevia/ISerializer/JsonSerializer.html">Bluevia::ISerializer::JsonSerializer</a></li>
        
          <li><a href="../Bluevia/ISerializer/MultipartSerializer.html">Bluevia::ISerializer::MultipartSerializer</a></li>
        
          <li><a href="../Bluevia/ISerializer/UrlEncodedSerializer.html">Bluevia::ISerializer::UrlEncodedSerializer</a></li>
        
          <li><a href="../Bluevia/Schemas.html">Bluevia::Schemas</a></li>
        
          <li><a href="../Bluevia/Schemas/AccessFields.html">Bluevia::Schemas::AccessFields</a></li>
        
          <li><a href="../Bluevia/Schemas/AccessInfo.html">Bluevia::Schemas::AccessInfo</a></li>
        
          <li><a href="../Bluevia/Schemas/Attachment.html">Bluevia::Schemas::Attachment</a></li>
        
          <li><a href="../Bluevia/Schemas/AttachmentInfo.html">Bluevia::Schemas::AttachmentInfo</a></li>
        
          <li><a href="../Bluevia/Schemas/BVResponse.html">Bluevia::Schemas::BVResponse</a></li>
        
          <li><a href="../Bluevia/Schemas/CreativeElement.html">Bluevia::Schemas::CreativeElement</a></li>
        
          <li><a href="../Bluevia/Schemas/DeliveryInfo.html">Bluevia::Schemas::DeliveryInfo</a></li>
        
          <li><a href="../Bluevia/Schemas/DirectoryDataSets.html">Bluevia::Schemas::DirectoryDataSets</a></li>
        
          <li><a href="../Bluevia/Schemas/LocationInfo.html">Bluevia::Schemas::LocationInfo</a></li>
        
          <li><a href="../Bluevia/Schemas/MimeContent.html">Bluevia::Schemas::MimeContent</a></li>
        
          <li><a href="../Bluevia/Schemas/MmsMessage.html">Bluevia::Schemas::MmsMessage</a></li>
        
          <li><a href="../Bluevia/Schemas/MmsMessageInfo.html">Bluevia::Schemas::MmsMessageInfo</a></li>
        
          <li><a href="../Bluevia/Schemas/PaymentResult.html">Bluevia::Schemas::PaymentResult</a></li>
        
          <li><a href="../Bluevia/Schemas/PaymentStatus.html">Bluevia::Schemas::PaymentStatus</a></li>
        
          <li><a href="../Bluevia/Schemas/PersonalFields.html">Bluevia::Schemas::PersonalFields</a></li>
        
          <li><a href="../Bluevia/Schemas/PersonalInfo.html">Bluevia::Schemas::PersonalInfo</a></li>
        
          <li><a href="../Bluevia/Schemas/Profile.html">Bluevia::Schemas::Profile</a></li>
        
          <li><a href="../Bluevia/Schemas/ProfileFields.html">Bluevia::Schemas::ProfileFields</a></li>
        
          <li><a href="../Bluevia/Schemas/ProtectionPolicy.html">Bluevia::Schemas::ProtectionPolicy</a></li>
        
          <li><a href="../Bluevia/Schemas/RequestToken.html">Bluevia::Schemas::RequestToken</a></li>
        
          <li><a href="../Bluevia/Schemas/SimpleAdResponse.html">Bluevia::Schemas::SimpleAdResponse</a></li>
        
          <li><a href="../Bluevia/Schemas/SmsMessage.html">Bluevia::Schemas::SmsMessage</a></li>
        
          <li><a href="../Bluevia/Schemas/TerminalFields.html">Bluevia::Schemas::TerminalFields</a></li>
        
          <li><a href="../Bluevia/Schemas/TerminalInfo.html">Bluevia::Schemas::TerminalInfo</a></li>
        
          <li><a href="../Bluevia/Schemas/TypeId.html">Bluevia::Schemas::TypeId</a></li>
        
          <li><a href="../Bluevia/Schemas/UserIdType.html">Bluevia::Schemas::UserIdType</a></li>
        
          <li><a href="../Bluevia/Schemas/UserInfo.html">Bluevia::Schemas::UserInfo</a></li>
        
          <li><a href="../Bluevia/Utils.html">Bluevia::Utils</a></li>
        
          <li><a href="../OAuth.html">OAuth</a></li>
        
          <li><a href="../OAuth/Client.html">OAuth::Client</a></li>
        
          <li><a href="../OAuth/Client/Helper.html">OAuth::Client::Helper</a></li>
        
          <li><a href="../Rack.html">Rack</a></li>
        
          <li><a href="../Rack/Multipart.html">Rack::Multipart</a></li>
        
          <li><a href="../Rack/Multipart/Parser.html">Rack::Multipart::Parser</a></li>
        
          <li><a href="../BlueviaLogger.html">BlueviaLogger</a></li>
        
          <li><a href="../DemoAdvertising.html">DemoAdvertising</a></li>
        
          <li><a href="../DemoDirectory.html">DemoDirectory</a></li>
        
          <li><a href="../DemoLocation.html">DemoLocation</a></li>
        
          <li><a href="../DemoMmsMo.html">DemoMmsMo</a></li>
        
          <li><a href="../DemoMmsMt.html">DemoMmsMt</a></li>
        
          <li><a href="../DemoOauth.html">DemoOauth</a></li>
        
          <li><a href="../DemoPayment.html">DemoPayment</a></li>
        
          <li><a href="../DemoSmsMo.html">DemoSmsMo</a></li>
        
          <li><a href="../DemoSmsMt.html">DemoSmsMt</a></li>
        
          <li><a href="../Hash.html">Hash</a></li>
        
          <li><a href="../Object.html">Object</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    
<p><a href="../Bluevia.html">Bluevia</a> Payment Client Guide</p>

<p>Introduction</p>

<pre>The Bluevia Payment API is a set of functions that enables individual, 
atomic payments based on input economic information. This guide represents 
a practical introduction to developing applications in which the user wants 
to provide the Bluevia Payment functionality.</pre>

<p><a href="../Bluevia.html">Bluevia</a> Payment API: making payment sessions</p>

<pre>A payment session allows to charge a precise, economic amount, on the user's account.</pre>

<p>Payment Client basics</p>

<pre>Payment client represents the client side in a classic client-server schema. 
This object wraps up the underlying RPC client side functionality needed to 
perform requests against a RPC server. 

Any Bluevia client performs requests and receives responses in a secure mode. 
Clients are authorized following the OAuth protocol. This security protocol 
enables users to grant third-party access to their resources without sharing 
their passwords. So clients store the authorization data -called security 
credentials- to grant access to the server. 

Bluevia Payment API uses an extension of OAuth protocol to guarantee secure 
payment operations. For each payment the user makes he must complete the OAuth 
process to identify itself and get a valid access token. These tokens will be 
valid for 48 hours and then will be dismissed. Following sections describe 
what security credentials we are talking about and the modifications this API needs.</pre>

<p>Creating a Payment client: BVPayment class</p>

<pre>First step for using Payment client is to create a BVPayment object. This 
object can have three different working modes: 

- LIVE or BVMODE::LIVE Your application uses real network, which means that you 
  will be able to send real transactions to real Movistar, O2 and Vivo customers 
  in the applicable country.
- SANDBOX or BVMODE::SANDBOX Sandbox environment offers you the exact same 
  experience as Live environment except that no traffic is generated on live network.</pre>

<p>Payment API <a href="../OAuth.html">OAuth</a> protocol</p>

<pre>Bluevia uses OAuth as its authentication mechanism which enables websites and 
applications to access Bluevia API's without end users disclosing their personal 
credentials.

In order to grant access to the server any client has to be created passing the 
security credential as parameter in its constructor. These security credentials 
are managed internally and added as a HTTP header in every request sent to the server.

Such Oauth security credentials are:

- Consumer key: String identifying the application (obtained when you registered 
  your application within the provisioning portal.
- Consumer secret: A secret -a string- used by the consumer to establish ownership 
  of the consumer key

To authorize each payment operation a new valid access token has to be retrieved, 
completing this special OAuth process.</pre>

<p>Payment client features: code example</p>

<pre>Note that this feature is only available for SANDBOX and LIVE modes. 

@bc = BVPayment.new(BVMode::LIVE,&quot;[CONSUMER_KEY]&quot;,&quot;[CONSUMER_SECRET]&quot;)</pre>

<p>Step 1: retrieving a request token</p>

<pre>First, you have to retrieve a request token to be authorised by the user. 
In this case you have to use the get_payment_request_token function, which 
includes the Payment info besides the usual request tokens params:

@request_payment_token = @bc.get_payment_request_token(amount, currency, name, 
                                                       service_id, 
                                                       callback = &quot;oob&quot;)

This time :callback can't be a msisdn but is still an optional parameter.

As with BVOauth client, response is a RequestToken object that includes the request 
token and secret, and the user authorization url, in order to get the user pin code. 
You can also provide a callback for automatic redirection, for web implementation. 
Request token and token secret are also kept inside the client for
convenience when calling the following process of getting access token and secret.</pre>

<p>Step 2: retrieveing an access token</p>

<pre>With the obatined oauth_verifier, you can now get the access token from the user 
using the function:

   result = @service.get_payment_access_token( USER_PIN_CODE )</pre>

<p>Step 3: making a payment</p>

<pre>Request tokens are preserved for 48 hours, untill used in a payment request or 
cancelled. Hence, developer alternatively may create another BVPayment client and 
use this call to get the access token information (set_token method use below). 

   @bc.set_token(access_token)

Then payment method can be called. It's a once shot function. Once used with a 
oauth token, given in the client constructor, it cannot be used again to make a 
payment (but it can be used to retrieve the status of the operation).

If the result status of the process of payment is successful then a transaction 
identifier is returned in a Bluevia::Schemas::PaymentResult.

This function provides the main feature of the API, making payments.

It is possible to receive status notifications by providing Bluevia with an 
URI where notifications must be sent:

   response = @bc.payment(amount, currency, endpoint, correlator)

Params:

    - amount: Amount to be charged, it may be an economic amount or a number of 
    'virtual units' (points, tickets, etc) (mandatory). 
    - currency: Type of currency which corresponds with the amount above, following
    ISO 4217 (mandatory).
    - endpoint:  Endpoint to receive notifications of payments operations (optional). 
    - correlator:  An string to correlate the requests and the notifications (optional).</pre>

<p>Payment client features : get payment status</p>

<pre>'get_payment_status' function allows to request the status of a previous payment 
operation. 

Use its transaction identifier as sole parameter. 

   result = @bc.get_payment_status(response.transaction_id)

returns a Bluevia::Schemas::PaymentStatus object with transaction_status and 
transaction_status_description.</pre>

<p>Payment client features : cancel_authorization</p>

<pre>If token is no longer needed it's also possible to cancel the authorization

   result = @bc.cancel_authorization()

returns true if successful and false if unsuccessful</pre>

<p><a href="../Bluevia.html">Bluevia</a> Payment API: code examples</p>

<pre>begin

      # 1. Create client (you have to choose the mode and include the OAuth 
      # authorization values. No access token is needed)

      @bc = BVPayment.new(BVMode::LIVE,&quot;[CONSUMER_KEY]&quot;,&quot;[CONSUMER_SECRET]&quot;)

      # 2. OAuth process
      @payment_request = @bc.get_payment_request_token(&quot;100&quot;, &quot;GBP&quot;, &quot;bluevia&quot;, 
                                                    &quot;service_id&quot;)

      # Authorization in Bluevia Connect Portal
      # Get OAuth verifier from GUI
      oauth_verifier = &quot;12345&quot;
      @payment_access = @bc.get_payment_access_token(oauth_verifier, 
                                                 payment_request.token, 
                                                 payment_request.secret)

      # 3. Make payment
      result = @bc.payment(&quot;100&quot;, &quot;GBP&quot;);

      transaction_identifier = result.transaction_id

      # 4. Get Payment status
      status = @bc.get_payment_status transaction_identifier
      status_information = status.transaction_status

rescue BlueviaError =&gt; e
      puts e.code
      puts e.message
      # as for example
end</pre>

  </div>

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>
</body>
</html>

